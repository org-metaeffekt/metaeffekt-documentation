> [Documentation](../../README.md) >
> [Vulnerability Management](../vulnerability-management.md) >
> CSP Loader

# CSP Loader

> [Introduction](#introduction) -
> [Format](#format) -
> [Example](#example)

## Introduction

The Central Security Policy Configuration manages various parameters about your environment that can change the way
vulnerability information is aggregated or displayed in your reports.
The process of loading the CSP has gone through several iterations, starting with an inline XML definition in your
pom.xml files over the concept of loading from a JSON file with an overwrite option using JSON in the pom.xml to the
latest version of a dedicated CspLoader instance.

The conceptual changes this introduces are that you can now define multiple policies in one or more JSON files and
mix-and-match them as you need by referencing their unique ids, automatically extend other configurations and parse from
regular JSON configuration files.

## Format

Each CSP configuration JSON file can contain an array of configuration blocks. Each block defines:

- `id`: A unique identifier for the configuration.
- `configuration`: An inline object OR a relative string path to another JSON file that holds the configuration JSON.
- `extends` (optional): A list of configuration IDs that this configuration builds upon that will be loaded before the
  others.
- `activeByDefault` (optional): Whether this configuration should be active no matter what. Will be loaded before other
  user-specified configurations.

Example of a single configuration block:

<!-- @formatter:off -->
```json
{
  "id": "config a",
  "extends": ["config b"],
  "configuration": {
    "cvssSeverityRanges": "escalate:strong-red:9.0:,due:strong-dark-orange:7.0:8.9,elevated:strong-light-orange::6.9",
    "cvssVersionSelectionPolicy": ["HIGHEST"],
    "includeAdvisoryTypes": ["notice"]
  }
}
```
<!-- @formatter:on -->

### cspLoader configuration

The old way of specifying

Whenever a security policy is needed, a `securityPolicy` property can be filled in your `pom.xml` files to customize the
generation.
It has the following properties:

- `file`: Single file to parse that uses the format listed above this chapter.
- `files`: List of files to parse that use the format listed above this chapter.
- `activeIds`: A string list of configuration ids that should be activated. Can either be a CSV value of Ids or an
  explicit XML list of Ids.
- `inlineOverwriteJson`: A JSON Object of properties to apply right before parsing the effective configuration.

The variants of the `file` and `files` parameters are provided to more easily allow the configuration of simple or more
complex file setups.

<!-- @formatter:off -->
```xml
<configuration>
    <securityPolicy>
        <!-- either a single file -->
        <file/>
        <!-- or multiple files in a list -->
        <files>
           <file/>
        </files>
        <activeIds/>
       <inlineOverwriteJson/>
    </securityPolicy>
</configuration>
```
<!-- @formatter:on -->

[A full example](#example) is provided below.

### Resolution Process

The CSP Loader processes configurations using the following steps:

1. **File Loading**:
    * JSON files listed in the `file` and `files` section are loaded.
    * Each file can contain multiple configuration blocks.

2. **Activation Resolution**:
    * Configurations listed in `activeIds` are activated.
    * Any configurations extended by the active configurations are also activated recursively.
      They are scheduled to be loaded before the `activeIds` configurations.
    * Configurations marked with `activeByDefault: true` are also activated unless overridden.
      They are scheduled to be loaded before the extended configurations.

3. **Configuration Filtering**:
    * From the total loaded configurations, only those determined as active are selected for merging.

4. **Merging Process**:
    * Configuration JSON properties are merged in dependency order.
    * Always active configurations are applied first, then the extended and finally the user-specified configurations;
      overriding configuration values are layered on top.

5. **Inline Overwrite**:
    * The optional `inlineOverwriteJson` is parsed and applied last as a final override layer.

6. **Final Effective Configuration**:
    * The result is a single unified configuration used during vulnerability filtering and reporting.

## Example

The example below illustrates all features the CSP Loader can provide.
A larger, real-world example
[can be found in the documentation-template project](https://github.com/org-metaeffekt/metaeffekt-documentation-template/pull/24/files#diff-168061628b4421d936a0593327c5199b2f4dc63f78cca8dd864db0bfd345697c).

- `pom.xml`

<!-- @formatter:off -->
```xml
<configuration>
    <securityPolicy>
        <files>
            <file>file-1.json</file>
            <file>file-2.json</file>
        </files>
        <activeIds>
            <id>config a</id>
            <id>config d</id>
        </activeIds>
        <inlineOverwriteJson>{"insignificantThreshold":7.8}</inlineOverwriteJson>
    </securityPolicy>
</configuration>
```
<!-- @formatter:on -->

- `file-1.json`

<!-- @formatter:off -->
```json
[
  {
    "id": "config d",
    "configuration": {
      "insignificantThreshold": 7.8,
      "includeAdvisoryTypes": ["alert"]
    }
  },
  {
    "id": "config a",
    "extends": ["config b"],
    "configuration": {
      "cvssSeverityRanges": "escalate:strong-red:9.0:,due:strong-dark-orange:7.0:8.9,elevated:strong-light-orange::6.9",
      "cvssVersionSelectionPolicy": ["HIGHEST"],
      "includeAdvisoryTypes": ["notice"]
    }
  },
  {
    "id": "config b",
    "configuration": {
      "cvssSeverityRanges": ">0.8:strong-red:0.8:,>0.1:strong-light-orange:0.1:0.8,>0.01:strong-yellow:0.01:0.1,≤0.01:pastel-gray::0.01"
    }
  }
]
```
<!-- @formatter:on -->

- `file-2.json`

<!-- @formatter:off -->
```json
[
  {
    "id": "config c",
    "activeByDefault": true,
    "configuration": "file-3.json"
  }
]
```
<!-- @formatter:on -->

- `file-3.json`

<!-- @formatter:off -->
```json
{
  "includeScoreThreshold": 5
}
```
<!-- @formatter:on -->

In the example, the CSP Loader processes the configuration as follows:

1. `file-1.json` and `file-2.json` provide configs `a`, `b`, `c`, and `d`. `config c` includes `file-3.json`.
2. Activation:
    - Explicit: `config a`, `config d`
    - Extends: `config b` (required by `a`)
    - Default: `config c` (marked `activeByDefault`)
3. Merge Order:
    - `config b` → `config c` → `config a` → `config d`
    - Later configs override earlier ones.
4. Result:
    - `cvssSeverityRanges` from `a` overrides `b`
    - `includeScoreThreshold` comes from `c`
    - `includeAdvisoryTypes` and `insignificantThreshold` from `d`
    - `cvssVersionSelectionPolicy` from `a`

```bash
Building configurations from Ids: [config a, config d]
- Loading file://file-1.json
  ↳ Parsed [3] configurations
- Loading file://file-2.json
  ↳ Parsed [1] configurations
- Activating configuration(s): [config c, config a, config d]
- Activating configuration [config b] because it is extended by [config a]
Filtered total configurations [4] [config d, config a, config b, config c] to selected configurations [4] [config b, config c, config a, config d]
Merging [4] configurations into effective configuration
- [config b]: {"cvssSeverityRanges":">0.8:strong-red:0.8:,>0.1:strong-light-orange:0.1:0.8,>0.01:strong-yellow:0.01:0.1,≤0.01:pastel-gray::0.01"}
- [config c]: {"includeScoreThreshold":5}
- [config a]: {"includeAdvisoryTypes":["notice"],"cvssSeverityRanges":"escalate:strong-red:9.0:,due:strong-dark-orange:7.0:8.9,elevated:strong-light-orange::6.9","cvssVersionSelectionPolicy":["HIGHEST"]}
- [config d]: {"includeAdvisoryTypes":["alert"],"insignificantThreshold":7.8}
  ↳ {"includeAdvisoryTypes":["alert"],"includeScoreThreshold":5,"insignificantThreshold":7.8,"cvssSeverityRanges":"escalate:strong-red:9.0:,due:strong-dark-orange:7.0:8.9,elevated:strong-light-orange::6.9","cvssVersionSelectionPolicy":["HIGHEST"]}
```

The resulting merged configuration from the above example is:

<!-- @formatter:off -->
```json
{
  "includeAdvisoryTypes": ["alert"],
  "includeScoreThreshold": 5,
  "insignificantThreshold": 7.8,
  "cvssSeverityRanges": "escalate:strong-red:9.0:,due:strong-dark-orange:7.0:8.9,elevated:strong-light-orange::6.9",
  "cvssVersionSelectionPolicy": ["HIGHEST"]
}
```
<!-- @formatter:on -->
