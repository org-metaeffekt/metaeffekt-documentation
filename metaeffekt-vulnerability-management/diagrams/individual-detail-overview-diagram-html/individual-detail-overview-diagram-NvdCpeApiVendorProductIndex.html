<!DOCTYPE html>
<html>
<head>
    <title>Cytoscape.js Graph with Swimlanes</title>
    <style>
        #cy {
            width: 100%;
            height: 100vh;
            display: block;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <!-- Include Cytoscape.js -->
    <script src="https://unpkg.com/cytoscape@3.19.1/dist/cytoscape.min.js"></script>
    <!-- Include cytoscape-node-html-label -->
    <script src="https://unpkg.com/cytoscape-node-html-label@1.2.0/dist/cytoscape-node-html-label.js"></script>
    <!-- Include dom-to-image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <!-- Include html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Include dagre for layout -->
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.3.0/cytoscape-dagre.js"></script>
</head>
<body>

<div id="cy"></div>

<script>
    var elements = [{"data":{"id":"downloadersGroup","label":"Downloaders"},"classes":["graph-container"]},{"data":{"id":"indexesGroup","label":"Indexes"},"classes":["graph-container"]},{"data":{"id":"indexQueriesGroup","label":"Index Queries"},"classes":["graph-container"]},{"data":{"id":"enrichersGroup","label":"Enrichment Pipeline"},"classes":["graph-container"]},{"data":{"parent":"enrichersGroup","id":"phaseGroup_PRODUCT_IDENTIFICATION","label":"Product Identification"},"classes":["graph-container","enricher-phase"]},{"data":{"parent":"downloadersGroup","id":"com.metaeffekt.mirror.download.nvd.NvdCveApiDownload","label":"<b>NVD CVE API</b><br>nvd / nvdCveDownload"},"classes":["graph-node","downloader"]},{"data":{"parent":"downloadersGroup","id":"com.metaeffekt.mirror.download.nvd.NvdCpeApiDownload","label":"<b>NVD CPE API</b><br>cpe-dict / nvdCpeDownload"},"classes":["graph-node","downloader"]},{"data":{"parent":"downloadersGroup","id":"com.metaeffekt.mirror.download.nvd.CveListGitDownload","label":"<b>CVE List Git</b><br>cve-list / cveListDownload"},"classes":["graph-node","downloader"]},{"data":{"parent":"indexesGroup","id":"com.metaeffekt.mirror.index.nvd.NvdCveApiIndex","label":"<b>NVD CVE API</b><br>nvd-cve / nvdVulnerabilityIndex"},"classes":["graph-node","index"]},{"data":{"parent":"indexesGroup","id":"com.metaeffekt.mirror.index.nvd.NvdCpeApiIndex","label":"<b>NVD CPE API</b><br>cpe-dict / nvdCpeIndex"},"classes":["graph-node","index"]},{"data":{"parent":"indexesGroup","id":"com.metaeffekt.mirror.index.nvd.NvdCpeApiVendorProductIndex","label":"<b>NVD CPE API Vendor Product</b><br>cpe-dict-vp / nvdCpeVendorProductIndex"},"classes":["graph-node","index"]},{"data":{"parent":"indexQueriesGroup","id":"com.metaeffekt.mirror.query.NvdCpeApiVendorProductIndexQuery","label":"<b>NVD CPE API Vendor Product</b>"},"classes":["graph-node","index-query"]},{"data":{"parent":"phaseGroup_PRODUCT_IDENTIFICATION","id":"com.metaeffekt.artifact.enrichment.vulnerability.CpeDerivationEnrichment","label":"<b>CPE URI derivation</b><br>cpe-derived / cpeDerivationEnrichment"},"classes":["graph-node","enricher"]}];

    var edges = [{"data":{"source":"com.metaeffekt.mirror.download.nvd.NvdCveApiDownload","label":"Index -> Download","target":"com.metaeffekt.mirror.index.nvd.NvdCveApiIndex"}},{"data":{"source":"com.metaeffekt.mirror.download.nvd.CveListGitDownload","label":"Index -> Optional Download","target":"com.metaeffekt.mirror.index.nvd.NvdCveApiIndex"}},{"data":{"source":"com.metaeffekt.mirror.index.nvd.NvdCpeApiVendorProductIndex","label":"Index -> Optional Index","target":"com.metaeffekt.mirror.index.nvd.NvdCveApiIndex"}},{"data":{"source":"com.metaeffekt.mirror.index.nvd.NvdCpeApiIndex","label":"Index -> Optional Index","target":"com.metaeffekt.mirror.index.nvd.NvdCveApiIndex"}},{"data":{"source":"com.metaeffekt.mirror.download.nvd.NvdCpeApiDownload","label":"Index -> Download","target":"com.metaeffekt.mirror.index.nvd.NvdCpeApiIndex"}},{"data":{"source":"com.metaeffekt.mirror.index.nvd.NvdCpeApiIndex","label":"Index -> Index","target":"com.metaeffekt.mirror.index.nvd.NvdCpeApiVendorProductIndex"}},{"data":{"source":"com.metaeffekt.mirror.query.NvdCpeApiVendorProductIndexQuery","label":"IndexQuery -> Enricher","target":"com.metaeffekt.artifact.enrichment.vulnerability.CpeDerivationEnrichment"}},{"data":{"source":"com.metaeffekt.mirror.index.nvd.NvdCpeApiVendorProductIndex","label":"Index -> IndexQuery","target":"com.metaeffekt.mirror.query.NvdCpeApiVendorProductIndexQuery"}}];

    var cy = cytoscape({
        container: document.getElementById('cy'),

        elements: elements.concat(edges),

        style: [
            {
                selector: 'node',
                style: {
                    'label': '',
                    'text-valign': 'top',
                    'text-halign': 'left',
                    'shape': 'rectangle',
                    'background-color': '#FFFFFF',
                    'border-width': 1,
                    'border-color': '#000',
                    'font-size': 12,
                    'width': '360px',
                    'padding-left': '10px',
                    'padding-right': '10px',
                    'text-wrap': 'wrap',
                }
            },
            {
                selector: 'node.downloader',
                style: {
                    'height': '40px',
                }
            },
            {
                selector: 'node.index',
                style: {
                    'height': '40px',
                }
            },
            {
                selector: 'node.index-query',
                style: {
                    'height': '23px',
                    'width': '220px',
                }
            },
            {
                selector: 'node.enricher',
                style: {
                    'height': '40px',
                    'width': '500px',
                }
            },
            {
                selector: '$node > node', // parent nodes (compound nodes)
                style: {
                    'background-color': '#E0E0E0',
                    'shape': 'rectangle',
                    'padding': '20px',
                    'text-valign': 'top',
                    'text-halign': 'center',
                    'font-weight': 'bold',
                    'font-size': 14,
                    'border-width': 1,
                    'border-color': '#000',
                }
            },
            {
                selector: 'node[parent="downloadersGroup"]',
                style: {
                    'background-color': '#FFDAB9'
                }
            },
            {
                selector: 'node[parent="indexesGroup"]',
                style: {
                    'background-color': '#E6E6FA'
                }
            },
            {
                selector: 'node[parent="indexQueriesGroup"]',
                style: {
                    'background-color': '#FFFACD'
                }
            },
            {
                selector: 'node[parent="phase1Group"]',
                style: {
                    'background-color': '#D0D0F5'
                }
            },
            {
                selector: 'node[parent="phase2Group"]',
                style: {
                    'background-color': '#F0D0F5'
                }
            },
            {
                selector: 'node[parent="phase3Group"]',
                style: {
                    'background-color': '#D0F0F5'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': '#545454',
                    'target-arrow-shape': 'triangle',
                    'target-arrow-color': '#545454',
                    'curve-style': 'bezier'
                }
            },
            {
                selector: '.deprecated',
                style: {
                    'border-color': '#ff6767',
                    'border-width': 3,
                }
            }
        ],

        layout: {
            name: 'dagre',
            rankDir: 'LR',
            nodeSep: 60,
            edgeSep: 10,
            rankSep: 100,
            padding: 20
        }
    });

    // initialize the node HTML labels as separate dom elements instead of using the default cytoscape labels
    cy.nodeHtmlLabel([
        {
            query: '.graph-container',
            halign: 'center',
            valign: 'top',
            halignBox: 'center',
            valignBox: 'top',
            cssClass: '',
            tpl: function (data) {
                return data.label;
            }
        },
        {
            query: '.graph-node',
            halign: 'left',
            valign: 'center',
            halignBox: 'right',
            valignBox: 'center',
            cssClass: '',
            tpl: function (data) {
                return data.label;
            }
        }
    ]);


    function download(filename, dataUrl) {
        const element = document.createElement('a');
        element.setAttribute('href', dataUrl);
        element.setAttribute('download', filename);

        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    document.addEventListener('keydown', function (event) {
        if (event.key === 's' || event.key === 'S') {
            domtoimage.toSvg(document.getElementById('cy'))
                .then(function (dataUrl) {
                    download('individual-detail-overview-diagram-NvdCpeApiVendorProductIndex.svg', dataUrl);
                })
                .catch(function (error) {
                    console.error('Error capturing SVG:', error);
                    alert('Check the console for an error message.');
                });
        }
    });

    document.addEventListener('keydown', function (event) {
        if (event.key === 'p' || event.key === 'P') {
            html2canvas(document.querySelector('#cy'), {scale: 2}).then(canvas => {
                var imageData = canvas.toDataURL('image/png');

                download(`individual-detail-overview-diagram-NvdCpeApiVendorProductIndex.png`, imageData);
            });
        }
    });
</script>

</body>
</html>
