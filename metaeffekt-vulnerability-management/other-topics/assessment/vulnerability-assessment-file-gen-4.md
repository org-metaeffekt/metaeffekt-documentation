> [Documentation](../../../README.md) >
> [Vulnerability Management](../../vulnerability-management.md) >
> Data Formats >
> Vulnerability Assessment File (Generation 4.x)

# Vulnerability Assessment (Generation 4.x)

The vulnerability assessment YAML format allows for the configuration of assessments that will be applied on
vulnerabilities to determine their status.

## Changes from 3.x

The new format differs from the [3.x versions](vulnerability-assessment-file-gen-3.md) in several aspects:

- `Vulnerability Status` and `History Entry` have been re-conceptualized to
  `Vulnerability Assessment` and `Assessment Event`
- History entries previously contained the entire status definition with their status, rationale, measures, etc.
  and upon creation of a new entry, all metrics had to be redefined and set to their old value.
  This new format introduces the concept of incremental assessments: An entry is constructed over multiple events, which
  each contribute one or more properties to the effective status. For example, an initial assessment event might define
  a status of `applicable` and a rationale,
  and a next one might provide a measure on how to deal with the vulnerability.
  This way, only the changed/new properties need to be defined and all previous ones are kept.
- CVSS modifications and reviewed advisories listings were previously listed as global properties on the top-level and
  not in the history entries. This has been changed: everything is now an event to not only make the history traceable,
  but also allow for incremental CVSS changes to be made.
- CVSS metric modifications now require a rationale to be defined per modification, or for multiple modifications at
  once.
- Each event must now contain a date value to allow for proper incremental ordering, which has become even more
  important than it was before.
- The schema version must now be explicitly be specified by the documents.
- Previously, assessment files with only one assessment on the top level of the file were allowed.
  Now, all assessments are contained in an `assessment` section.

An example:

```yaml
schema-version: "2.0"

assessments:
  - affects:
      vulnerabilities:
        - CVE-2021-4104
    events:
      - date: 2022-01-31
        status: applicable
        rationale: Application configuration allows exploitation.
```

## Schema Format

A short summary with all important terms:  
**Assessment Entries** are defined by **Assessment YAML files** in one or more
**Assessment Directories** that each contain some **General Information** on the file,
information on what vulnerabilities to **Affect** and zero or more
**Assessment Events** that are incrementally concatenated to obtain the effective Assessment upon evaluation.

> :warning: The exact schema will be published to https://metaeffekt.com/schema/artifact-analysis soon.

This section will explain the format alongside this illustration of the schema:

![The image shows the format of a vulnerability assessment entry. The entry is divided into multiple sections, including "General Information" "Affects" "Validation" and "Events". Each section contains various boxes with their contents describing the fields available.](assessment-4x-format.svg)

A full example for a file is listed at the bottom of the chapter.

### Top-Level Structure

- `schema-version` (required): Specifies the schema version, must be "2.0" for Generation 4.x assessments.
- `assessments` (required): An array of one or more assessment entries.

### Assessments (`assessments`)

Each assessment defines the following properties:

- `scope`:
    - `vulnerability`: Applies to vulnerabilities specified in the `affects` section.
    - `inventory`: Applies to all vulnerabilities in the inventory (bypasses `affects`).
      It is recommended to set `priority: -1` or lower for `inventory` scopes to ensure proper ordering.
- `affects` (mandatory on `vulnerability` scope): Specifies what vulnerabilities to apply the assessment on.
  At least one of the listed elements must match for the entry to be activated.
    - `vulnerabilities`: Array of vulnerability IDs (e.g., `CVE-2021-44228`) to apply the assessment on.
    - `cpe`: Array of CPE 2.2/2.3 strings (e.g., `cpe:/a:apache:log4j`).
    - `cwe`: Array of CWE IDs (e.g., `CWE-502`).
    - `condition`: A well-formed
      [Filter expression](https://github.com/org-metaeffekt/metaeffekt-documentation/blob/main/metaeffekt-vulnerability-management/other-topics/vulnerability-filter-format.md)
      (e.g., `attribute name == "CVE-2020-1234"`).
    - `labels`: If specified, the labels listed must match in addition to another `affects` criteria.
        - `includes`: At least one of the labels listed is required to match for the assessment to apply.
        - `excludes`: Labels that disqualify the assessment if present.
- `events` (mandatory): See sub-chapter below.
- `validation`: See [the validation chapter in this document](vulnerability-assessment-file-gen-3.md#validation) or
  [this example](vulnerability-assessment-file-gen-3.md#ex-5-inventory-validation).

### Assessment Events (`events`)

An array of incremental assessment events.
Events are evaluated in order based on their [intrinsic comparison order](#assessment-event-ordering),
with later events overriding earlier ones.
Each event must include (reqired):

- `date`: ISO 8601-alike date (either `2025-01-01`, `2025-01-01 10:00` or `2025-01-01 10:00:00`).

Assessment properties:

- `status`: One of `applicable`, `not applicable`, `insignificant`, or `void`.
- `author`
- `reported`/`accepted`: Identifies who reported/accepted the status.
- `rationale`: Explanation for the status and assessment.
- `risk`
- `measures`
- `score`: setting this property will fully overwrite the priority score displayed in the Vulnerability Assessment
  Dashboard.
- `priority`: Integer to override sorting (higher values take precedence), default: `0`.
- `advisory reviewed`:
    - List of objects with `id` (e.g., `CERTFR-2021-ALE-022`) and `rationale`.
- `cvss`: Supports CVSS v2.0, v3.0, v3.1, or v4.0 modifications.
  CVSS vector strings with metrics that will (conditionally) be applied to the selected vulnerability CVSS vector
  using the selection policy, creating an assessment (context) CVSS vector, score and severity.
  The CVSS metrics are incrementally added to each other to build larger vectors, just like the rest of the properties.
    - `reset modification`: Reset `1..n` or all metrics to their original values.
        - If `metrics` is set to `all`, all metrics will be reset.
        - If only specific metrics should be reset, list them individually split by a slash (e.g., `AV/AC`).
    - `overwrite metric`: Set a specific metric to a new value.
        - `metrics`: The metric to overwrite (e.g., `AV:A/AC:L`).
    - `lower/upper score`: Will only apply listed metrics if the resulting score is lower or equal to the score
      previously calculated.
    - `lower/upper metric`: Will only apply listed metrics if the metric is ranked lower to the metric already set.

Flags to determine whether the assessment event should be considered at all:

- `active`: Whether to include the event in the assessment evaluation.
- `discard prior events`:
  Essentially a `reset` flag, allowing to restart the assessment process.
  When this flag is set, all prior assessment events are discarded,
  and the current event becomes the new baseline for calculating the effective result.
  This leads to only the latest `discardPriorEvents` entry to be the effective starting point.
- `discard on subsequent events`: If there are later events, this event and all prior ones are discarded.
  If this is the latest event, it remains active.

```yaml
schema-version: "2.0"

assessments:
  - scope: vulnerability

    affects:
      vulnerabilities:
        - CVE-2021-44228
        - CVE-2021-45046
        - CVE-2022-2330
      cpe:
        - cpe:/a:apache:log4j
      cwe:
        - CWE-502
      condition: attribute name == "CVE-2020-1234"
      labels:
        includes: [ feature-3, feature-4 ]
        excludes:
          - feature-2
          - feature-1

    events:
      - status: not applicable
        date: 2020-01-01
      - status: applicable
        rationale: text-rationale
        risk: text-risk
        measures: text-measures
        score: 2.0
        author: Author
        date: 2025-01-01
        priority: 1

        reported: Author
        accepted: Author

        advisory reviewed:
          - id: CERTFR-2021-ALE-022
            rationale: This CERT-FR entry has been reviewed.

        cvss:
          v2.0:
            reset modification:
              - metrics: all
                rationale: New knowledge, resetting vector
            overwrite metric:
              - metrics: "AV:A"
                rationale: Application can only be accessed from the local company network
            lower score:
              - metrics: "AV:A"
                rationale: Application can only be accessed from the local company network
            lower metric:
              - metrics: "AV:A"
                rationale: Application can only be accessed from the local company network
            upper score:
              - metrics: "AV:A"
                rationale: Application can only be accessed from the local company network
            upper metric:
              - metrics: "AV:A"
                rationale: Application can only be accessed from the local company network

    validation:
      any artifact:
        exists:
          - field: Id
            function: equals
            value: log4j-core-*
          - field: Version
            function: version <=
            value: 2.16.0
```

## Effective Vulnerability Assessment

The Assessment Events can be collected from potentially many sources,
over several enrichment steps such as the Vulnerability Status or Keywords steps.
The calculation of what the true, effective assessment for a vulnerability is,
three steps need to run on the aggregated assessment events:

- Event Ordering: Determine the order of the assessment events based on their intrinsic properties.
- Event Filtering: Select only the applicable assessment events based on several properties.
- Effective Event Construction:
  Use the remaining and ordered events to collect the properties into an effective assessment.

---

### Event Ordering

Since events can be collected in any order, they must be sorted before evaluation.
Events are ranked using the following criteria, applied in order:

1. Events with a higher **priority** are ranked higher.
2. Events with the **inventory** scope are ranked lower.
3. **Inactive** events are ranked lower.
4. Events with a later **date** are ranked higher.
   The date is a mandatory field, since this is usually the last meaningful ordering criteria.
5. Events containing **rationale, measures, or risk information** are ranked higher.
6. Events with a **status** are ranked higher.
7. Events with a more **severe status** are ranked higher.

This guarantees a deterministic order for processing.

---

### Event Filtering

The filtering process is executed in separate steps to make sure that events are discarded according to the defined
logic.
The system will iterate over all assessment events for all the following rules,
no matter if they have already been marked as discarded:

#### Inactive Events

Any event marked as `active: false` is immediately marked as discarded.

#### Discard on Subsequent Events

If an event has this flag enabled, it will collect all later events.
If this list of events is non-empty:

- AND all events in this list have the `isAutoAppendedForDisplay` flag set, this entry does nothing.
- OTHERWISE, the event marks itself and all earlier events as discarded.

`isAutoAppendedForDisplay` is a system-only flag that is set on the assessment events that are appended by the system
if the base effective assessment does not have a status set.
This is usually the case if only an inventory-scope assessment has been provided.
It's best not to think about this flag too much, as it simply ensures behind the scenes that this automatically
generated assessment entry does not interfere with the manually specified ones.

Here's the source code for the creation of these automatic events:

<!-- @formatter:off -->
```java
public static VulnerabilityAssessmentEvent INSIGNIFICANT(double insignificantThreshold) {
  return VulnerabilityAssessmentEvent.builder()
    .status(VulnerabilityMetaData.STATUS_VALUE_INSIGNIFICANT)
    .rationale(String.format(Locale.GERMANY, "Vulnerability severity score is below insignificant threshold of %s.", insignificantThreshold))
    .date(TimeUtils.utcNow())
    .isAutoAppendedForDisplay(true)
    .build();
}

public static VulnerabilityAssessmentEvent IN_REVIEW() {
  return VulnerabilityAssessmentEvent.builder()
    .status(VulnerabilityMetaData.STATUS_VALUE_IN_REVIEW)
    .rationale("The vulnerability has automatically been marked as in review.")
    .date(TimeUtils.utcNow())
    .isAutoAppendedForDisplay(true)
    .build();
}
```
<!-- @formatter:on -->

#### Discard Prior Events

Essentially a reset flag.
If an event has this flag enabled, all preceding events are discarded, making this event the
new baseline for evaluation. Only the most recent event with this flag remains active.

---

### Effective Event Construction

Once the order of the events has been established and the relevant events are determined,
they are used to construct the effective vulnerability assessment.
The filtered events are processed from the first to the latest.

Each event contributes its properties to the assessment, applying them only if they are not already set.

- The following properties are overwritten on each assignment:
    - Status
    - Rationale
    - Risk
    - Measures
    - Score
- CVSS modifications are applied incrementally, collecting metrics and rationales:
    - CVSS v2
    - CVSS v3.0
    - CVSS v3.1
    - CVSS v4.0
- Reviewed advisories from all retained events are collected into the effective assessment.

Any events that were discarded during filtering are tracked separately as `unused source events`.
This is to allow a proper history to be built.

A full example with five individual assessment events specified by four different assessment entries:

![A more advanced example for the assessment entry collection. The individual events are being evaluated in order if their assessment entries are considers affected.](assessment-4x-process.svg)
