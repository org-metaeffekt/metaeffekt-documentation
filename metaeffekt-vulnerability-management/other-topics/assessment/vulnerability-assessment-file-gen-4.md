> [Documentation](../../../README.md) >
> [Vulnerability Management](../../vulnerability-management.md) >
> Data Formats >
> Vulnerability Assessment File (Generation 4.x)

# Vulnerability Assessment (Generation 4.x)

The vulnerability assessment YAML format allows for the configuration of assessments that will be applied on
vulnerabilities to determine their status.

## Changes from 3.x

The new format differs from the [3.x versions](vulnerability-assessment-file-gen-3.md) in several aspects:

- `Vulnerability Status` and `History Entry` have been renamed to `Vulnerability Assessment` and `Assessment Event`
- History entries previously contained an entire status definition with their status, rationale, measures, etc. and upon
  creation of a new entry, all metrics had to be redefined and set to their old value.
  This new format introduces the concept of incremental assessments: An entry is constructed over multiple events, which
  each contribute one or more properties to the effective status. For example, an initial assessment event might define
  a status of `Applicable` and a rationale, and a next one a measure on how to deal with the vulnerability.
  This way, only the changed/new properties need to be defined and all previous ones are kept.
- CVSS modifications and reviewed advisories listings were previously listed as global properties on the top-level and
  not in the history entries. This has been changed: everything is now an event to not only make the history traceable,
  but also allow for incremental CVSS changes to be made.
- CVSS metric modifications now require a rationale to be defined per modification.
- Each event must now contain a date value to allow for proper incremental ordering, which has become even more
  important than it was before.
- The schema version must now be explicitly be specified by the documents.
- Previously, assessment files with only one assessment on the top level of the file were allowed.
  Now, all assessments are contained in an `assessment` section.

## Schema Format

Generally, **Assessment Entries** are defined by **Assessment YAML files** in one or more
**Assessment Directories** that each contain some **General Information** on the file,
information on what vulnerabilities to **Affect** and zero or more
**Assessment Events** that are incrementally concatenated to obtain the effective Assessment upon evaluation.

> :warning: The exact schema will be published to https://metaeffekt.com/schema/artifact-analysis soon.

This section will explain the format alongside this illustration of the schema:

![The image shows the format of a vulnerability assessment entry. The entry is divided into multiple sections, including "General Information" "Affects" "Validation" and "Events". Each section contains various boxes with their contents describing the fields available.](assessment-4x-format.svg)

A full example for a file is listed at the bottom of the chapter.

### Top-Level Structure

- `schema-version` (required): Specifies the schema version, must be "2.0" for Generation 4.x assessments.
- `assessments` (required): An array of one or more assessment entries.

### Assessments (`assessments`)

Each assessment defines the following properties, where all except the `validation` are mandatory:

- `scope`:
    - `vulnerability`: Applies to vulnerabilities specified in the `affects` section.
    - `inventory`: Applies to all vulnerabilities in the inventory (bypasses `affects`).
      It is recommended to set `priority: -1` or lower for `inventory` scopes to ensure proper ordering.
- `affects`: Specifies what vulnerabilities to apply the assessment on.
  At least one of the listed elements must match for the entry to be activated.
    - `vulnerabilities`: Array of vulnerability IDs (e.g., `CVE-2021-44228`) to apply the assessment on.
    - `cpe`: Array of CPE 2.0/3.x strings (e.g., `cpe:/a:apache:log4j`).
    - `cwe`: Array of CWE IDs (e.g., `CWE-502`).
    - `condition`: A well-formed
      [Filter expression](https://github.com/org-metaeffekt/metaeffekt-documentation/blob/main/metaeffekt-vulnerability-management/other-topics/vulnerability-filter-format.md)
      (e.g., `attribute name == "CVE-2020-1234"`).
    - `labels`: If specified, the labels listed must match in addition to the other `affects` criteria.
        - `includes`: At least one of the labels listed is required to match for the assessment to apply.
        - `excludes`: Labels that disqualify the assessment if present.
- `events`: See sub-chapter below.
- `validation`: See [the validation chapter in this document](vulnerability-assessment-file-gen-3.md#validation) or
  [this example](vulnerability-assessment-file-gen-3.md#ex-5-inventory-validation).

### Assessment Events (`events`)

An array of incremental assessment events.
Events are evaluated in order based on their [intrinsic comparison order](#assessment-event-ordering),
with later events overriding earlier ones.
Each event must include (reqired):

- `status`: One of `applicable`, `not applicable`, `insignificant`, or `void`.
- `date`: ISO 8601-alike date (either `2025-01-01`, `2025-01-01 10:00` or `2025-01-01 10:00:00`).

Optional properties:

- `author`
- `reported`/`accepted`: Identifies who reported/accepted the status.
- `rationale`: Explanation for the status and assessment.
- `risk`
- `measures`
- `score`: setting this property will fully overwrite the priority score displayed in the Vulnerability Assessment
  Dashboard.
- `priority`: Integer to override sorting (higher values take precedence).
- `advisory reviewed`:
    - List of objects with `id` (e.g., `CERTFR-2021-ALE-022`) and `rationale`.
- `cvss`: Supports CVSS v2.0, v3.0, v3.1, or v4.0 modifications.
  CVSS vector strings with metrics that will (conditionally) be applied to the selected vulnerability CVSS vector
  using the selection policy, creating an assessment (context) CVSS vector, score and severity.
  The CVSS metrics are incrementally added to each other to build larger vectors, just like the rest of the properties.
    - `reset modification`: Reset `1..n` or all metrics to their original values.
        - If `metrics` is set to `all`, all metrics will be reset.
        - If only specific metrics should be reset, list them individually split by a slash (e.g., `AV/AC`).
    - `overwrite metric`: Set a specific metric to a new value.
        - `metrics`: The metric to overwrite (e.g., `AV:A/AC:L`).
    - `lower/upper score`: Will only apply listed metrics if the resulting score is lower or equal to the score
      previously calculated.
    - `lower/upper metric`: Will only apply listed metrics if the metric is ranked lower to the metric already set.
- `discard on subsequent events`: If there are later events, this event and all prior ones are discarded.
  If this is the latest event, it remains active.
- `discard prior events`: When this flag is set, all prior assessment events are discarded, and the current event
  becomes the new baseline for calculating the effective result.
  This leads to only the latest reset entry to be the effective starting point.
- `active`: Whether to include the event in the assessment evaluation.

```yaml
schema-version: "2.0"

assessments:
  - scope: vulnerability

    affects:
      vulnerabilities:
        - CVE-2021-44228
        - CVE-2021-45046
        - CVE-2022-2330
      cpe:
        - cpe:/a:apache:log4j
      cwe:
        - CWE-502
      condition: attribute name == "CVE-2020-1234"
      labels:
        includes: [ feature-3, feature-4 ]
        excludes:
          - feature-2
          - feature-1

    events:
      - status: not applicable
        date: 2020-01-01
      - status: applicable
        rationale: text-rationale
        risk: text-risk
        measures: text-measures
        score: 2.0
        author: Author
        date: 2025-01-01
        priority: 1

        reported: Author
        accepted: Author

        advisory reviewed:
          - id: CERTFR-2021-ALE-022
            rationale: This CERT-FR entry has been reviewed.

        cvss:
          v2.0:
            reset modification:
              - metrics: all
                rationale: New knowledge, resetting vector
            overwrite metric:
              - metrics: "AV:A"
                rationale: Application can only be accessed from the local company network
            lower score:
              - metrics: "AV:A"
                rationale: Application can only be accessed from the local company network
            lower metric:
              - metrics: "AV:A"
                rationale: Application can only be accessed from the local company network
            upper score:
              - metrics: "AV:A"
                rationale: Application can only be accessed from the local company network
            upper metric:
              - metrics: "AV:A"
                rationale: Application can only be accessed from the local company network

    validation:
      any artifact:
        exists:
          - field: Id
            function: equals
            value: log4j-core-*
          - field: Version
            function: version <=
            value: 2.16.0
```

## Assessment Event ordering

Since events are collected in potentially any order, they need to have an intrinsic ordering criteria that always allows
ordering them for evaluation.
The following rules are evaluated step by step, and the first matching one is the criteria that specifies the order
between the two events.

1. The entry with the higher `priority` is moved upwards.
2. The entry with the `inventory` scope is moved downwards.
3. The inactive entry is moved downwards.
4. The entry with the later `date` is moved upwards.

Since `date` is mandatory, this is usually the end of the comparison.
To ensure a consistent order, other properties are still evaluated:

5. The entry with a rationale, measures, or risk is moved upwards.
6. The entry with a status is moved upwards.
7. The entry with the more severe status is moved upwards.

## Evaluation Process

This step assumes that the events are already ordered.
When calculating the effective assessment state of a vulnerability,
the ordered events are considered individually one after another.

Finding the starting point:

- All `active = false` events are discarded.
- The last event that has the `discard on subsequent events` flag set that is not the latest event discards itself and
  all prior events.
- The last event that has the `discard prior events` flag set discards all prior events.
- The oldest event that is not discarded is the starting point.

Finding the effective assessment:

- The effective assessment is initialized as an empty object.
- Each event contributes to the effective assessment by adding or modifying properties:
    - All regular properties such as text fields, status, priority, etc.,
      simply set themselves in the effective assessment.
    - CVSS modifications are applied incrementally to the effective assessment's CVSS vector metric by metric.
    - Reviewed assessments are collected incrementally.

A full example with five individual assessment events specified by four different assessment entries:

![A more advanced example for the assessment entry collection. The individual events are being evaluated in order if their assessment entries are considers affected.](assessment-4x-process.svg)
