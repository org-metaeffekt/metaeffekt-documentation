> [Documentation](../../../README.md) >
> [Vulnerability Management](../../vulnerability-management.md) >
> Updating CVSS Entities 

# Updating CVSS Entities

> [Introduction](#introduction) -
> [Updating the CNA entities](#updating-the-cna-entities)

## Introduction

metaeffekt-core/libraries/ae-security/src/main/resources/cvss/entities/cna.json
metaeffekt-core/libraries/ae-security/src/main/resources/specification/jsonschema/cvss-entities.json

The CVE project allows partners (CNA, CVE Numbering Authorities) to register and manage their own CVE entries,
including the assignment of CVSS vectors.
This list of partners is relevant when the CVSS vectors are matched in the data mirror,
as it allows for the identification of the CNA responsible for the assignment of the CVSS vector.
This metadata has the benefit of providing additional metadata to a CVSS vector, instead of a simple name.

- The partners are available on: https://www.cve.org/PartnerInformation/ListofPartners
- Example partner: https://www.cve.org/PartnerInformation/ListofPartners/partner/Linux

In order for the vulnerability data mirror and enrichment process to be able to identify the responsible CNAs,
the process needs to know about them.
This is done using the format defined in the schema
[`metaeffekt-core/libraries/ae-security/src/main/resources/specification/jsonschema/cvss-entities.json`](https://github.com/org-metaeffekt/metaeffekt-core/tree/master/libraries/ae-security/src/main/resources/specification/jsonschema/cvss-entities.json).
The file
[`metaeffekt-core/libraries/ae-security/src/main/resources/cvss/entities/cna.json`](https://github.com/org-metaeffekt/metaeffekt-core/tree/master/libraries/ae-security/src/main/resources/cvss/entities/cna.json)
uses this schema to define the CNAs.

The file [cvss-cna-network.html](cvss-cna-network.html) visualizes the CNAs and their relationships.

This document attempts to explain how to update the CNA entities in the metaeffekt-core project.

## Updating the CNA entities

> I know. This code and the process are a bit of a mess.
> But they work, and you have to run them like once a year, so it's not too bad I think.

First, access the https://www.cve.org/PartnerInformation/ListofPartners page and switch from `Show` > `10` to
`Show` > `All` to display all partners.

Then, save the page as `partner_list.html` in the `data/nvd/YYYY-MM-DD/cna` directory as it is displayed by your
browser.

Create a project with these dependencies (and a couple more, but these are the important ones):

```xml

<dependencies>
    <dependency>
        <groupId>org.jsoup</groupId>
        <artifactId>jsoup</artifactId>
        <version>1.16.1</version>
    </dependency>
    <dependency>
        <groupId>org.seleniumhq.selenium</groupId>
        <artifactId>selenium-java</artifactId>
        <version>4.10.0</version>
    </dependency>
    <dependency>
        <groupId>io.github.bonigarcia</groupId>
        <artifactId>webdrivermanager</artifactId>
        <version>5.7.0</version>
    </dependency>
</dependencies>
```

Execute this code:

```java
import com.metaeffekt.artifact.analysis.utils.TimeUtils;
import io.github.bonigarcia.wdm.WebDriverManager;
import lombok.extern.slf4j.Slf4j;
import org.json.JSONArray;
import org.json.JSONObject;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.metaeffekt.core.util.FileUtils;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.support.ui.WebDriverWait;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.text.SimpleDateFormat;
import java.time.Duration;
import java.util.*;
import java.util.stream.Collectors;

@Slf4j
public class CnaExtractor {

    public static void main(String[] args) {
        WebDriverManager.chromedriver().setup();

        WebDriver driver = new ChromeDriver();

        try {
            // has to be done manually, download the https://www.cve.org/PartnerInformation/ListofPartners page as indicated by the documentation.
            // downloadHtml("https://www.cve.org/PartnerInformation/ListofPartners", "data/nvd/cna");
            // if (true) return;

            final SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");
            dateFormat.setTimeZone(TimeZone.getTimeZone("UTC"));
            final File baseDir = new File("data/nvd/" + dateFormat.format(new Date(TimeUtils.utcNow())) + "/cna");
            baseDir.mkdirs();

            // https://www.cve.org/PartnerInformation/ListofPartners
            // expand all and download using singlefile
            final File htmlFile = new File(baseDir, "partner_list.html");

            try {
                final Document doc = Jsoup.parse(htmlFile, "UTF-8");

                final Element table = doc.select(".table-container table").first();
                if (table != null) {
                    final List<OverviewTablePartnerInfo> partners = parseTable(table);

                    for (int i = 0; i < partners.size(); i++) {
                        final OverviewTablePartnerInfo partner = partners.get(i);
                        log.info((i + 1) + " / " + partners.size() + ": " + partner);
                        if (partner.downloadDetailsPage(driver, baseDir)) {
                            Thread.sleep(500);
                        }
                    }

                    final JSONArray allCnaDetails = new JSONArray();

                    for (int i = 0; i < partners.size(); i++) {
                        final OverviewTablePartnerInfo partner = partners.get(i);
                        final JSONObject cnaDetails = extractPartnerDetails(partner.getDetailsPageFile(baseDir));
                        cnaDetails.put("partnerName", partner.getPartnerName());
                        cnaDetails.put("cveOrgDetailsLink", partner.getPartnerLink());
                        allCnaDetails.put(cnaDetails);
                    }

                    FileUtils.write(new File(baseDir, "all_cna_details.json"), allCnaDetails.toString(), StandardCharsets.UTF_8);

                } else {
                    throw new RuntimeException("No table found!");
                }

            } catch (IOException e) {
                e.printStackTrace();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        } finally {
            driver.quit();
        }
    }

    public static JSONObject extractPartnerDetails(File htmlFile) {
        try {
            final Document doc = Jsoup.parse(htmlFile, "UTF-8");

            final Element table = doc.select("table.table.cve-border-dark-blue.is-striped.is-hoverable.mb-1").first();
            if (table == null) {
                throw new RuntimeException("No details table found in " + htmlFile.getAbsolutePath());
            }

            final Map<String, Object> partnerDetails = partnerDetailsParseTable(table);
            final List<ReportSteps> reportSteps = partnerDetailsExtractSteps(doc);
            partnerDetails.put("steps", reportSteps.stream().map(ReportSteps::toJson).collect(Collectors.toList()));

            return new JSONObject(partnerDetails);
        } catch (IOException e) {
            throw new RuntimeException("Error parsing " + htmlFile.getAbsolutePath(), e);
        }
    }

    private static List<ReportSteps> partnerDetailsExtractSteps(Document doc) {
        List<ReportSteps> steps = new ArrayList<>();
        Elements stepElements = doc.select("div.stepsToReport nav.level div.level-item");

        for (int i = 0; i < stepElements.size(); i++) {
            Element stepElement = stepElements.get(i);
            String title = stepElement.select("p.mb-1").text().replaceAll("Step \\d+: ", "");
            Element linkElement = stepElement.select("a").first();

            String link = linkElement != null ? linkElement.attr("href") : "";

            steps.add(new ReportSteps(i + 1, title, link));
        }

        return steps;
    }

    private static Map<String, Object> partnerDetailsParseTable(Element table) {
        Map<String, Object> details = new HashMap<>();
        Elements rows = table.select("tr");

        for (Element row : rows) {
            Elements th = row.select("th");
            Elements td = row.select("td");

            if (!th.isEmpty() && !td.isEmpty()) {
                String key = th.text().trim().replace("Country*", "Country");
                Object value = td.text().trim();

                // Special handling for links
                if (!td.select("a").isEmpty()) {
                    value = td.select("a").attr("href");
                }

                if (key.equals("Organization Type")) {
                    value = Arrays.asList(value.toString().split(",?\\s+"));
                }

                details.put(key, value);
            }
        }
        return details;
    }

    private static List<OverviewTablePartnerInfo> parseTable(Element table) {
        final List<OverviewTablePartnerInfo> partners = new ArrayList<>();
        final Elements rows = table.select("tr");

        for (Element row : rows) {
            final Elements cells = row.select("th, td");
            if (!cells.isEmpty()) {
                final String partnerName = cells.get(1).text();
                final String scope = cells.get(2).text();
                final String programRole = cells.get(3).text();
                final List<String> organizationTypes = Arrays.asList(cells.get(4).text().split(",\\s*"));
                final String country = cells.get(5).text();
                final String partnerLink = cells.select("a").attr("href");

                final OverviewTablePartnerInfo overviewTablePartnerInfo = new OverviewTablePartnerInfo(partnerName, scope, programRole, organizationTypes, country, partnerLink);
                partners.add(overviewTablePartnerInfo);
            }
        }

        partners.removeIf(overviewTablePartnerInfo -> overviewTablePartnerInfo.getPartnerName().equals("Partner"));

        return partners;
    }

    public static boolean downloadHtml(WebDriver driver, String url, String localDirectory) {
        File file = new File(localDirectory + "/" + extractFileName(url));

        if (!file.exists()) {
            log.info("Downloading {} to {}", url, file.getAbsolutePath());
            driver.get(url);
            new WebDriverWait(driver, Duration.ofSeconds(10))
                    .until(webDriver -> ((ChromeDriver) webDriver).executeScript("return document.readyState").equals("complete"));

            try (FileWriter writer = new FileWriter(file)) {
                writer.write(driver.getPageSource());
            } catch (IOException e) {
                e.printStackTrace();
            }
            return true;
        } else {
            log.info("Skipping {} as {} already exists.", url, file.getAbsolutePath());
            return false;
        }
    }

    private static String extractFileName(String url) {
        // Extract a suitable file name from the URL
        return url.substring(url.lastIndexOf('/') + 1) + ".html";
    }

    public static class ReportSteps {
        private final int stepIndex;
        private final String title;
        private final String link;

        public ReportSteps(int stepIndex, String title, String link) {
            this.stepIndex = stepIndex;
            this.title = title;
            this.link = link;
        }

        public int getStepIndex() {
            return stepIndex;
        }

        public String getTitle() {
            return title;
        }

        public String getLink() {
            return link;
        }

        @Override
        public String toString() {
            return "StepInfo{" +
                    "stepIndex=" + stepIndex +
                    ", title='" + title + '\'' +
                    ", link='" + link + '\'' +
                    '}';
        }

        public JSONObject toJson() {
            return new JSONObject()
                    .put("stepIndex", stepIndex)
                    .put("title", title)
                    .put("link", link);
        }
    }


    public static class OverviewTablePartnerInfo {
        private final String partnerName;
        private final String scope;
        private final String programRole;
        private final List<String> organizationTypes;
        private final String country;
        private final String partnerLink;

        public OverviewTablePartnerInfo(String partnerName, String scope, String programRole, List<String> organizationTypes, String country, String partnerLink) {
            this.partnerName = partnerName;
            this.scope = scope;
            this.programRole = programRole;
            this.organizationTypes = organizationTypes;
            this.country = country;
            this.partnerLink = partnerLink;
        }

        // Getters for each field
        public String getPartnerName() {
            return partnerName;
        }

        public String getScope() {
            return scope;
        }

        public String getProgramRole() {
            return programRole;
        }

        public List<String> getOrganizationTypes() {
            return organizationTypes;
        }

        public String getCountry() {
            return country;
        }

        public String getPartnerLink() {
            return partnerLink;
        }

        public File getDetailsPageFile(File baseDir) {
            return new File(baseDir, extractFileName(partnerLink));
        }

        public boolean downloadDetailsPage(WebDriver driver, File baseDir) {
            return downloadHtml(driver, partnerLink, baseDir.getAbsolutePath());
        }

        @Override
        public String toString() {
            return "PartnerInfo{" +
                    "partnerName='" + partnerName + '\'' +
                    ", scope='" + scope + '\'' +
                    ", programRole='" + programRole + '\'' +
                    ", organizationTypes=" + organizationTypes +
                    ", country='" + country + '\'' +
                    ", partnerLink='" + partnerLink + '\'' +
                    '}';
        }
    }
}
```

And then this code right here. The relevant JSON is written to `cna_initializations.json`:

```java
import com.metaeffekt.artifact.analysis.utils.TimeUtils;
import org.apache.commons.lang3.ObjectUtils;
import org.apache.commons.lang3.StringUtils;
import org.json.JSONArray;
import org.json.JSONObject;
import org.metaeffekt.core.util.FileUtils;

import java.io.File;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.text.SimpleDateFormat;
import java.util.*;
import java.util.stream.Collectors;

public class CnaJsonCodeGenerator {
    public static void main(String[] args) throws IOException {
        final SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");
        dateFormat.setTimeZone(TimeZone.getTimeZone("UTC"));
        final File baseDir = new File("data/nvd/" + dateFormat.format(new Date(TimeUtils.utcNow())) + "/cna");
        baseDir.mkdirs();

        File outFile = new File(baseDir, "cna_initializations.json");

        final JSONArray json = new JSONArray(FileUtils.readFileToString(new File(baseDir, "all_cna_details.json")));
        final Map<String, JSONObject> jsonEntries = generateEntityInitializations(json);

        final JSONObject jsonFile = new JSONObject();
        for (String key : jsonEntries.keySet()) {
            jsonFile.put(key, jsonEntries.get(key));
        }

        FileUtils.write(outFile, jsonFile.toString(), StandardCharsets.UTF_8);
        System.out.println("Wrote file: " + outFile.getAbsolutePath());
        System.out.println("Entries: " + jsonEntries.size());
    }

    private static Map<String, JSONObject> generateEntityInitializations(JSONArray json) {
        final Map<String, JSONObject> jsonFiles = new HashMap<>();
        for (int i = 0; i < json.length(); i++) {
            final JSONObject jsonObject = json.getJSONObject(i);
            appendEntityInitialization(jsonObject, jsonFiles);
        }
        return jsonFiles;
    }

    private static void appendEntityInitialization(JSONObject json, Map<String, JSONObject> jsonFiles) {
        String partnerName = json.optString("partnerName", null);

        if (partnerName == null) {
            throw new IllegalStateException("partnerName is null:\n" + json.toString(2));
        }

        String email = extractEmail(json.optJSONArray("steps"));
        String url = json.optString("Security Advisories");
        if (StringUtils.isEmpty(url) || url.equals("N/A")) {
            url = extractHttpLink(json.optJSONArray("steps"));
        }
        String cveOrgDetailsLink = json.optString("cveOrgDetailsLink", null);
        if (!cveOrgDetailsLink.startsWith("http")) {
            cveOrgDetailsLink = "https://www.cve.org" + cveOrgDetailsLink;
        }

        String description = json.optString("Scope", null);
        String country = json.optString("Country", null);
        String role = json.optString("Program Role", null);
        List<String> organizationTypes = json.has("Organization Type") ? json.getJSONArray("Organization Type").toList().stream()
                .map(Object::toString)
                .collect(Collectors.toList())
                : Collections.emptyList();

        String topLevelRoot = json.has("Top-Level Root") ? trimRootPath(json.getString("Top-Level Root")) : null;
        String root = json.has("Root") ? trimRootPath(json.getString("Root")) : null;

        String variableName = generateVariableName(ObjectUtils.firstNonNull(cveOrgDetailsLink, partnerName));

        final JSONObject jsonData = new JSONObject();
        jsonData.put("name", partnerName);
        jsonData.put("email", email);
        jsonData.put("url", url);
        jsonData.put("cveOrgDetailsLink", cveOrgDetailsLink);
        jsonData.put("description", description);
        jsonData.put("country", country);
        jsonData.put("role", role);
        jsonData.put("organizationTypes", organizationTypes);
        jsonData.put("topLevelRoot", topLevelRoot == null ? null : generateVariableName(topLevelRoot));
        jsonData.put("root", root == null ? null : generateVariableName(root));
        jsonData.put("reportSteps", json.optJSONArray("steps"));

        jsonFiles.put(variableName, jsonData);
    }

    private static String extractEmail(JSONArray steps) {
        if (steps != null) {
            for (int i = 0; i < steps.length(); i++) {
                JSONObject step = steps.getJSONObject(i);
                String link = step.optString("link", "");
                if (link.startsWith("mailto:")) {
                    return link.substring("mailto:".length());
                }
            }
        }
        return null;
    }

    private static String extractHttpLink(JSONArray steps) {
        if (steps != null) {
            for (int i = 0; i < steps.length(); i++) {
                JSONObject step = steps.getJSONObject(i);
                String link = step.optString("link", "");
                if (link.startsWith("http")) {
                    return link;
                }
            }
        }
        return null;
    }

    private static String trimRootPath(String topLevelRoot) {
        return topLevelRoot.replace("/PartnerInformation/ListofPartners/partner/", "");
    }

    private static String generateReportSteps(JSONArray steps) {
        StringBuilder reportSteps = new StringBuilder();
        if (steps != null) {
            for (int i = 0; i < steps.length(); i++) {
                JSONObject step = steps.getJSONObject(i);
                if (i > 0) reportSteps.append(", ");
                reportSteps.append("new ReportStep(")
                        .append(step.getInt("stepIndex")).append(", ")
                        .append("\"").append(step.optString("title", "")).append("\", ")
                        .append("\"").append(step.optString("link", "")).append("\")");
            }
        }
        return reportSteps.toString();
    }

    public static String generateVariableName(String partnerName) {
        partnerName = partnerName.trim()
                .replace("https://www.cve.org/PartnerInformation/ListofPartners/partner/", "");

        if (partnerName.equalsIgnoreCase("mitre") || partnerName.equalsIgnoreCase("mitre corporation")) {
            return "CVE_CNA_MITRE";
        }

        final String baseName = "CVE_CNA_" + partnerName.toUpperCase()
                .replaceAll("\\s+|\\W", "_")
                .replaceAll("_+", "_")
                .replaceAll("_$", "");

        return baseName;
    }
}
```

And that's it! Replace the file in the core project with this new one and you're done.
