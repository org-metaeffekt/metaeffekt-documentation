package com.metaeffekt.documentation.provider;

import com.metaeffekt.artifact.analysis.utils.StringUtils;
import com.metaeffekt.artifact.analysis.utils.TimeUtils;
import com.metaeffekt.documentation.DocumentationContext;
import com.metaeffekt.documentation.DocumentationDataProvider;
import com.metaeffekt.documentation.domain.DocumentedType;
import com.metaeffekt.documentation.util.MirrorUtils;
import com.metaeffekt.mirror.index.Index;
import com.metaeffekt.mirror.query.IndexQuery;
import com.thoughtworks.qdox.model.JavaAnnotation;
import com.thoughtworks.qdox.model.JavaClass;
import com.thoughtworks.qdox.model.JavaMethod;
import com.thoughtworks.qdox.model.expression.AnnotationValue;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.tuple.Pair;
import org.apache.lucene.document.Document;

import java.io.File;
import java.util.*;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.function.Supplier;
import java.util.stream.Collectors;

import static com.metaeffekt.documentation.util.MarkdownDocUtils.*;

@Slf4j
public class DataSourceExampleDataProvider implements DocumentationDataProvider {

    private final static int AMOUNT_EXAMPLES_PER_INDEX = 40;
    private final static boolean TESTING = false;
    private final static int MAX_SKIP_COUNT = TESTING ? 100 : 6000;
    private final static int AMOUNT_DISPLAY_EXAMPLES_PER_INDEX = 5;
    private final static int MAX_EXAMPLE_LENGTH = 1300;

    private final static List<String> FIELD_NAME_DISPLAY_ORDER = Arrays.asList(
            "id",
            "name",
            "url",
            "link",
            "summary",
            "description",
            "cwe",
            "cpe23Uri",
            "product",
            "vendor",
            "type",
            "family",
            "vulnerability",
            "cvssVectors",
            "cvss",
            "severity",
            "threat",
            "affectedProducts",
            "createDate",
            "updateDate",
            "lastModified",
            "releaseDate",
            "publishDate",
            "dueDate",
            "nvdPublishedAt",
            "knownRansomwareCampaignUse",
            "eol",
            "lts",
            "support",
            "cycle",
            "latestReleaseDate",
            "latest",
            "deprecated",
            "references",
            "kbId",
            "rel",
            "recommendations",
            "recommendation",
            "workarounds",
            "msRemediations",
            "implementation",
            "sourceImplementation",
            "other",
            "vulnerable_software",
            "vulnerable_software_vp",
            "titles",
            "version",
            "language",
            "part",
            "edition",
            "update",
            "sources",
            "acknowledgements",
            "keywords",
            "percentile",
            "epssScore"
    );

    @Override
    public Map<String, Supplier<String>> getTemplateVariables(DocumentationContext context) {
        Map<String, Supplier<String>> variables = new HashMap<>();

        List<JavaClass> indexJavaClasses = context.getType(Index.class).findSubtypes().stream()
                .map(DocumentedType::getJavaClass)
                .collect(Collectors.toList());
        indexJavaClasses = MirrorUtils.orderMirrorClasses(context, indexJavaClasses);
        indexJavaClasses = excludeAllThatAreExtendedByOthers(indexJavaClasses);

        List<Class<? extends Index>> indexClasses = findClasses(context, indexJavaClasses);

        List<JavaClass> indexQueryClasses = context.getType(IndexQuery.class).findSubtypes().stream()
                .map(DocumentedType::getJavaClass)
                .collect(Collectors.toList());
        indexQueryClasses = MirrorUtils.orderMirrorClasses(context, indexQueryClasses);
        indexQueryClasses = excludeAllThatAreExtendedByOthers(indexQueryClasses);

        Map<Class<? extends Index>, JavaClass> indexUsageInIndexQuery = mapIndexQueries(context, indexQueryClasses);

        List<IndexExample> examples = selectExampleDocuments(context, indexClasses);

        variables.put("index-examples-structure", () -> generateIndexStructure(examples, indexUsageInIndexQuery, context));
        variables.put("index-examples-toc", () -> generateToc(examples));

        return variables;
    }

    private String generateIndexStructure(List<IndexExample> examples, Map<Class<? extends Index>, JavaClass> indexUsageInIndexQuery, DocumentationContext context) {
        StringBuilder sb = new StringBuilder();
        for (IndexExample indexExample : examples) {
            Index index = indexExample.getIndex();
            String name = formatClassNameApplyDeprecated(index.getClass());

            JavaAnnotation meta = getMirrorMetadata(context.getClassByName(index.getClass().getName()));
            String dir = getAnnotationValue(meta, "directoryName");
            String prop = getAnnotationValue(meta, "mavenPropertyName");

            sb.append("## ").append(name).append("\n\n")
                    .append("`").append(dir).append("` / `").append(prop).append("`  \n")
                    .append("`").append(indexExample.getDocumentCount()).append("` documents as of `").append(indexExample.getIndexTime()).append("`\n\n");

            Map<String, Set<String>> fields = new HashMap<>();
            for (Document document : indexExample.getDocuments()) {
                document.getFields()
                        .forEach(field -> {
                            final String fieldName = field.name();
                            fields.computeIfAbsent(fieldName, k -> new LinkedHashSet<>()).add(field.stringValue().trim().replace("\n", "<br>"));
                        });
            }

            sb.append("| Field | Random Examples |\n")
                    .append("| --- | --- |\n");
            fields.entrySet().stream()
                    .sorted(Comparator.comparingInt(entry -> FIELD_NAME_DISPLAY_ORDER.indexOf(entry.getKey())))
                    .forEach(entry -> {
                        final String fieldName = entry.getKey();

                        final Set<String> vals = entry.getValue().stream().filter(StringUtils::notEmpty).collect(LinkedHashSet::new, LinkedHashSet::add, LinkedHashSet::addAll);
                        final StringJoiner examplesJoiner = new StringJoiner("`<br>`", "`", "`").setEmptyValue("No examples found");
                        vals.stream()
                                .sorted(Comparator.comparingInt(String::hashCode))
                                .limit(AMOUNT_DISPLAY_EXAMPLES_PER_INDEX)
                                .filter(example -> example.length() < MAX_EXAMPLE_LENGTH)
                                .forEach(examplesJoiner::add);

                        final Set<String> detectedTypes = vals.stream()
                                .map(this::tryToDetectFieldType)
                                .collect(LinkedHashSet::new, LinkedHashSet::add, LinkedHashSet::addAll);

                        sb.append("| `").append(fieldName).append("`")
                                .append(detectedTypes.size() == 1 ? "<br>â†’ " + detectedTypes.iterator().next() : "")
                                .append(" | ").append(examplesJoiner).append(" |\n");
                    });

            sb.append("\n");

            JavaClass queryClass = indexUsageInIndexQuery.get(index.getClass());
            if (queryClass != null) {
                sb.append("Used in Index Query **").append(formatClassName(queryClass)).append("**, which provides the following query methods:\n\n");
                for (Pair<JavaClass, JavaMethod> method : findRelevantQueryMethods(queryClass)) {
                    sb.append(MirrorDataProvider.createSourceCodeExpandable(method.getKey(), method.getValue()).getKey());
                }
                sb.append("\n");
            } else {
                sb.append("Not used in any Index Query\n\n");
            }
        }
        return sb.toString();
    }

    private String generateToc(List<IndexExample> examples) {
        StringJoiner sj = new StringJoiner("\n");
        examples.forEach(ex -> {
            String name = formatClassNameApplyDeprecated(ex.getIndex().getClass());
            sj.add("- [" + name + "](#" + toMarkdownId(name) + ")");
        });
        return sj.toString();
    }

    private List<Class<? extends Index>> findClasses(DocumentationContext context, List<JavaClass> javaClasses) {
        List<Class<? extends Index>> result = new ArrayList<>();
        for (JavaClass jc : javaClasses) {
            try {
                result.add((Class<? extends Index>) context.loadClass(jc));
            } catch (Exception e) {
                throw new IllegalStateException("Class not found: " + jc.getFullyQualifiedName(), e);
            }
        }
        return result;
    }

    private Map<Class<? extends Index>, JavaClass> mapIndexQueries(DocumentationContext context, List<JavaClass> indexQueryClasses) {
        Map<Class<? extends Index>, JavaClass> map = new LinkedHashMap<>();
        for (JavaClass jc : indexQueryClasses) {
            if (jc.getFullyQualifiedName().contains("CustomVulnerabilityIndexQuery")) continue;
            if (jc.getFullyQualifiedName().contains("GhsaAdvisorIndexQuery")) continue;

            try {
                Class<?> clazz = context.loadClass(jc);
                Object instance = clazz.getConstructor(File.class).newInstance(context.getMirrorPath());
                IndexQuery query = (IndexQuery) instance;
                map.put(query.getIndex().getClass(), jc);
            } catch (Exception e) {
                log.error("Failed to create query instance for class {}", jc.getName(), e);
            }
        }
        return map;
    }

    private List<IndexExample> selectExampleDocuments(DocumentationContext context, List<Class<? extends Index>> indexClasses) {
        List<IndexExample> indexQueryExampleDocuments = new ArrayList<>();

        for (Class<? extends Index> indexClass : indexClasses) {
            if (indexClass.getName().contains("CustomVulnerabilityIndexQuery")) continue;
            if (indexClass.getName().contains("GhsaAdvisorIndex")) continue;

            try {
                final Index index;
                try {
                    index = indexClass.getConstructor(File.class).newInstance(context.getMirrorPath());
                } catch (Exception e) {
                    if (isDeprecated(indexClass)) {
                        System.err.println("Could not construct deprecated index instance for class [" + indexClass + "] due to: " + e.getMessage());
                        continue;
                    }
                    throw new IllegalStateException("Could not construct index instance for class [" + indexClass + "]", e);
                }

                final AtomicInteger remainingExamples = new AtomicInteger(AMOUNT_EXAMPLES_PER_INDEX);
                final int skipPerExample = Math.max(0, Math.min(MAX_SKIP_COUNT, index.documentCount() / AMOUNT_EXAMPLES_PER_INDEX - remainingExamples.get()));
                final AtomicInteger skip = new AtomicInteger(skipPerExample);

                final IndexExample indexExample = new IndexExample(index);
                indexQueryExampleDocuments.add(indexExample);
                indexExample.setDocumentCount(index.documentCount());

                System.out.println("Processing index query: " + index + " with " + index.documentCount() + " documents, skipping " + skipPerExample + " documents per example.");

                index.findAndProcessAllDocumentsCancelable(document -> {
                    if (skip.getAndDecrement() > 0) return true;
                    skip.set(skipPerExample);

                    indexExample.getDocuments().add(document);
                    return remainingExamples.decrementAndGet() > 0;
                });
            } catch (Exception e) {
                throw new IllegalStateException("Failed to select example documents for [" + indexClass.getName() + "]: " + e.getMessage(), e);
            }
        }

        return indexQueryExampleDocuments;
    }

    @Data
    protected static class IndexExample {
        private final Index index;
        private List<Document> documents;
        private int documentCount;
        private String indexTime;

        public IndexExample(Index index) {
            this.index = index;
            this.documents = new ArrayList<>();
            this.documentCount = 0;
            this.indexTime = TimeUtils.formatNormalizedDate(new Date(index.getDirectoryLastUpdated()));
        }
    }

    private String tryToDetectFieldType(String value) {
        if (value == null) return "String";

        if (value.matches("\\d{13}")) return "timestamp";
        if (value.matches("\\d{4}-\\d{2}-\\d{2}")) return "timestamp";
        if (value.matches("\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}")) return "timestamp";

        if (value.matches("\\d+")) return "number";
        if (value.matches("\\d+\\.\\d+")) return "number";
        if (value.matches("true|false")) return "boolean";

        if (value.startsWith("{") && value.endsWith("}")) return "JSON Object";
        if (value.startsWith("[") && value.endsWith("]")) return "JSON Array";

        if (value.startsWith("http")) return "link";

        if (value.startsWith("cpe:")) return "CPE URI";

        return "String";
    }

    private List<Pair<JavaClass, JavaMethod>> findRelevantQueryMethods(JavaClass indexQuery) {
        List<Pair<JavaClass, JavaMethod>> methods = new ArrayList<>();
        for (JavaMethod m : indexQuery.getMethods()) {
            if (!m.isAbstract() && m.getName().startsWith("find")) {
                methods.add(Pair.of(indexQuery, m));
            }
        }
        JavaClass sup = indexQuery.getSuperJavaClass();
        if (sup != null && !sup.getName().equals("IndexQuery")) {
            methods.addAll(findRelevantQueryMethods(sup));
        }
        return methods;
    }

    private JavaAnnotation getMirrorMetadata(JavaClass clazz) {
        return clazz.getAnnotations().stream()
                .filter(a -> a.getType().getValue().equals("MirrorMetadata"))
                .findFirst().orElse(null);
    }

    private String getAnnotationValue(JavaAnnotation a, String key) {
        if (a == null) return "???";
        AnnotationValue val = a.getProperty(key);
        return val != null ? val.getParameterValue().toString().replace("\"", "") : "???";
    }
}