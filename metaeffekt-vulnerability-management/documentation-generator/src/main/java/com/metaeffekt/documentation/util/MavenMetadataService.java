package com.metaeffekt.documentation.util;

import com.thoughtworks.qdox.model.JavaClass;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import java.io.File;
import java.net.URL;
import java.util.HashMap;
import java.util.Map;

@Slf4j
@RequiredArgsConstructor
public class MavenMetadataService {

    private final Map<String, MavenCoordinates> pomCache = new HashMap<>();

    public MavenCoordinates getMavenCoordinates(JavaClass clazz) {
        try {
            final URL sourceUrl = clazz.getSource().getURL();
            if (sourceUrl == null) {
                return MavenCoordinates.UNKNOWN;
            }

            // Traverse up from source file to find pom.xml
            File currentDir = new File(sourceUrl.toURI()).getParentFile();
            while (currentDir != null && currentDir.exists()) {
                File pomFile = new File(currentDir, "pom.xml");
                if (pomFile.exists()) {
                    return parsePom(pomFile);
                }
                currentDir = currentDir.getParentFile();
            }
        } catch (Exception e) {
            log.warn("Failed to determine maven coordinates for {}: {}", clazz.getName(), e.getMessage());
        }
        return MavenCoordinates.UNKNOWN;
    }

    private MavenCoordinates parsePom(File pomFile) {
        if (pomCache.containsKey(pomFile.getAbsolutePath())) {
            return pomCache.get(pomFile.getAbsolutePath());
        }

        String groupId = "unknown";
        String artifactId = "unknown";
        String parentGroupId = null;

        try {
            DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();
            DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();
            Document doc = dBuilder.parse(pomFile);
            doc.getDocumentElement().normalize();

            Element projectElement = doc.getDocumentElement();

            artifactId = getTagValue(projectElement, "artifactId");
            groupId = getTagValue(projectElement, "groupId");

            // Handle Parent inheritance
            NodeList parents = projectElement.getElementsByTagName("parent");
            if (parents.getLength() > 0) {
                Element parent = (Element) parents.item(0);
                parentGroupId = getTagValue(parent, "groupId");
            }

            if ((groupId == null || groupId.isEmpty()) && parentGroupId != null) {
                groupId = parentGroupId;
            }

        } catch (Exception e) {
            log.error("Error parsing POM {}: {}", pomFile.getAbsolutePath(), e.getMessage());
        }

        MavenCoordinates coords = new MavenCoordinates(
                groupId != null ? groupId : "unknown",
                artifactId != null ? artifactId : "unknown"
        );
        pomCache.put(pomFile.getAbsolutePath(), coords);
        return coords;
    }

    private String getTagValue(Element element, String tagName) {
        NodeList nodeList = element.getChildNodes();
        for (int i = 0; i < nodeList.getLength(); i++) {
            Node node = nodeList.item(i);
            if (node.getNodeType() == Node.ELEMENT_NODE && node.getNodeName().equals(tagName)) {
                return node.getTextContent().trim();
            }
        }
        return null;
    }

    public static class MavenCoordinates {
        public static final MavenCoordinates UNKNOWN = new MavenCoordinates("unknown", "unknown");

        public final String groupId;
        public final String artifactId;

        public MavenCoordinates(String groupId, String artifactId) {
            this.groupId = groupId;
            this.artifactId = artifactId;
        }
    }
}
