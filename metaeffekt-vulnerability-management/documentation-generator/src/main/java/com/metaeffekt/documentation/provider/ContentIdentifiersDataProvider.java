package com.metaeffekt.documentation.provider;

import com.metaeffekt.documentation.DocumentationContext;
import com.metaeffekt.documentation.DocumentationDataProvider;
import com.metaeffekt.mirror.contents.store.*;
import com.thoughtworks.qdox.model.JavaClass;
import com.thoughtworks.qdox.model.JavaField;

import java.util.HashMap;
import java.util.Map;
import java.util.function.Supplier;
import java.util.regex.Pattern;

import static com.metaeffekt.documentation.util.MarkdownDocUtils.firstNonNull;
import static com.metaeffekt.documentation.util.MarkdownDocUtils.formatClassName;

public class ContentIdentifiersDataProvider implements DocumentationDataProvider {

    @Override
    public Map<String, Supplier<String>> getTemplateVariables(DocumentationContext context) {
        Map<String, Supplier<String>> variables = new HashMap<>();

        variables.put("store-doc-advisory", () -> generateStoreTable(context, AdvisoryTypeStore.get(), AdvisoryTypeStore.class));
        variables.put("store-doc-vulnerability", () -> generateStoreTable(context, VulnerabilityTypeStore.get(), VulnerabilityTypeStore.class));
        variables.put("store-doc-other", () -> generateStoreTable(context, OtherTypeStore.get(), OtherTypeStore.class));

        return variables;
    }

    private String generateStoreTable(DocumentationContext context, ContentIdentifierStore<?> storeInstance, Class<?> storeClass) {
        // Find Source Class for comments
        JavaClass javaClazz = context.getClassByName(storeClass.getName());
        if (javaClazz == null) {
            throw new IllegalStateException("Content Identifier Store Class " + storeClass.getName() + " not found in source.");
        }

        boolean isVulnerability = VulnerabilityTypeStore.class.isAssignableFrom(storeClass);
        boolean isAdvisory = AdvisoryTypeStore.class.isAssignableFrom(storeClass);

        StringBuilder doc = new StringBuilder();

        // Table Header
        doc.append("| Name | Display Name | Implementation |");
        if (isVulnerability) doc.append(" Data Type | Query Type |");
        if (isAdvisory) doc.append(" Data Type | Query Type |");
        doc.append(" ID Pattern | Comment |\n");

        doc.append("|------|--------------|----------------|");
        if (isVulnerability) doc.append("-----------|-----------|");
        if (isAdvisory) doc.append("-----------|-----------|");
        doc.append("------------|---------|\n");

        // Table Rows
        for (ContentIdentifierStore.ContentIdentifier identifier : storeInstance.values()) {
            appendIdentifierRow(doc, identifier, javaClazz, isVulnerability, isAdvisory);
        }

        return doc.toString();
    }

    private void appendIdentifierRow(StringBuilder doc, ContentIdentifierStore.ContentIdentifier identifier, JavaClass javaClazz, boolean isVuln, boolean isAdv) {
        String name = identifier.getName();
        String wellFormedName = identifier.getWellFormedName();
        String implementation = identifier.getImplementation();

        Pattern p = firstNonNull(identifier.getIdPattern(), Pattern.compile("UNKNOWN"));
        String idPattern = p.pattern().replace("|", "\\|");

        // Extract Comment from Field
        JavaField field = javaClazz.getFields().stream()
                .filter(f -> f.getCodeBlock().contains("\"" + name + "\""))
                .findFirst()
                .orElseThrow(() -> new IllegalStateException("Field for " + name + " not found in " + javaClazz.getName()));

        String comment = field.getComment() == null ? "" : field.getComment().replaceAll("\n", "<br>").replaceAll("\r", "");

        doc.append("| ").append(name)
                .append(" | ").append(wellFormedName)
                .append(" | ").append(implementation.equals(name) ? "" : implementation)
                .append(" | ");

        if (isVuln) {
            VulnerabilityTypeIdentifier<?> vId = (VulnerabilityTypeIdentifier<?>) identifier;
            doc.append(safeFormatClass(vId.getVulnerabilityClass())).append(" | ")
                    .append(safeFormatClass(vId.getVulnerabilityIndexQueryClass())).append(" | ");
        }
        if (isAdv) {
            AdvisoryTypeIdentifier<?> aId = (AdvisoryTypeIdentifier<?>) identifier;
            doc.append(safeFormatClass(aId.getAdvisoryClass())).append(" | ")
                    .append(safeFormatClass(aId.getAdvisorIndexQueryClass())).append(" | ");
        }

        doc.append("<code>").append(idPattern).append("</code> | ")
                .append(comment).append(" |").append("\n");
    }

    private String safeFormatClass(Class<?> clazz) {
        if (clazz == null) return "";
        try {
            return formatClassName(clazz);
        } catch (Exception e) {
            return "";
        }
    }
}