package com.metaeffekt.documentation;

import com.metaeffekt.documentation.provider.*;
import com.metaeffekt.documentation.util.DocumentationProperties;
import com.metaeffekt.documentation.util.ImageUtils;
import lombok.extern.slf4j.Slf4j;

import java.io.File;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.function.Supplier;

@Slf4j
public class DocumentationGenerator {

    public static void main(String[] args) {
        log.info("Starting Documentation Generator...");
        final DocumentationContext context = new DocumentationContext(
                DocumentationProperties.getArtifactAnalysisPath(),
                DocumentationProperties.getCorePath(),
                DocumentationProperties.getMirrorPath(),
                DocumentationProperties.getDocumentationProjectPath()
        );

        generateDocumentation(context);
        // cropImages(context);  // run only if the images were re-generated
    }

    private static void generateDocumentation(DocumentationContext context) {
        try {
            TemplateRegistry registry = new TemplateRegistry();
            List<DocumentationDataProvider> providers = new ArrayList<>();

            providers.add(new CspDocumentationProvider());
            providers.add(new ContentIdentifiersDataProvider());
            providers.add(new InventoryEnrichmentDataProvider());
            providers.add(new MirrorDataProvider());
            providers.add(new DataSourceExampleDataProvider());
            providers.add(new CvssCnaInfoDataProvider());
            providers.add(new EolDataDataProvider());
            providers.add(new MsrcKbChainDataProvider());
            providers.add(new OverviewChartDataProvider());
            providers.add(new IndividualIndexDiagramsDataProvider());

            for (DocumentationDataProvider provider : providers) {
                log.info("Loading variables from provider: {}", provider.getClass().getSimpleName());
                Map<String, Supplier<String>> variables = provider.getTemplateVariables(context);
                log.info("  {}", variables.keySet());
                registry.registerAll(variables);
            }

            TemplateProcessor processor = new TemplateProcessor(registry, context);
            processor.processTemplates();

            log.info("Documentation generation finished successfully.");

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private static void cropImages(DocumentationContext context) {
        log.info("Running Image Cropping...");

        try {
            File docPath = context.getDocumentationProjectPath();
            File diagramDir = new File(docPath, "metaeffekt-vulnerability-management/diagrams/individual-detail-overview-diagram-rendered");
            if (diagramDir.exists()) {
                ImageUtils.cropImagesInDirectoryToColoredArea(diagramDir, "individual-detail-overview-diagram", 10);
            } else {
                log.warn("Diagram directory not found for cropping: {}", diagramDir);
            }

            File overviewFile = new File(docPath, "metaeffekt-vulnerability-management/large-overview-diagram.png");
            if (overviewFile.exists()) {
                ImageUtils.cropImageToColoredArea(overviewFile, overviewFile, 10);
            } else {
                log.warn("Overview diagram not found for cropping: {}", overviewFile);
            }
        } catch (Exception e) {
            log.error("Failed to crop images", e);
        }
    }
}
