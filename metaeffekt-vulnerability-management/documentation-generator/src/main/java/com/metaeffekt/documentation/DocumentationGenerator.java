package com.metaeffekt.documentation;

import com.metaeffekt.documentation.provider.*;
import com.metaeffekt.documentation.util.DocumentationProperties;
import lombok.extern.slf4j.Slf4j;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.function.Supplier;

@Slf4j
public class DocumentationGenerator {

    public static void main(String[] args) {
        try {
            log.info("Starting Documentation Generator (Pull Model)...");

            DocumentationContext context = new DocumentationContext(
                    DocumentationProperties.getArtifactAnalysisPath(),
                    DocumentationProperties.getCorePath(),
                    DocumentationProperties.getMirrorPath(),
                    DocumentationProperties.getDocumentationProjectPath()
            );

            TemplateRegistry registry = new TemplateRegistry();
            List<DocumentationDataProvider> providers = new ArrayList<>();

            providers.add(new CspDocumentationProvider());
            providers.add(new ContentIdentifiersDataProvider());
            providers.add(new InventoryEnrichmentDataProvider());
            providers.add(new MirrorDataProvider());
            providers.add(new DataSourceExampleDataProvider());
            providers.add(new CvssCnaInfoDataProvider());
            providers.add(new EolDataDataProvider());
            providers.add(new MsrcKbChainDataProvider());
            providers.add(new OverviewChartDataProvider());
            providers.add(new IndividualIndexDiagramsDataProvider());

            for (DocumentationDataProvider provider : providers) {
                log.info("Loading variables from provider: {}", provider.getClass().getSimpleName());
                Map<String, Supplier<String>> variables = provider.getTemplateVariables(context);
                log.info("  {}", variables.keySet());
                registry.registerAll(variables);
            }

            TemplateProcessor processor = new TemplateProcessor(registry, context);
            processor.processTemplates();

            log.info("Documentation generation finished successfully.");

        } catch (Exception e) {
            log.error("Critical failure during generation", e);
            e.printStackTrace();
            System.exit(1);
        }
    }

    public static Class<?> loadClass(String fullyQualifiedName) {
        try {
            return Class.forName(fullyQualifiedName);
        } catch (ClassNotFoundException e) {
            throw new RuntimeException("Unable to load class [" + fullyQualifiedName + "]", e);
        }
    }
}
